name: Aloception unit tests
on:
  push:
    branches:
      - 'master'
  pull_request:
    branches:
      - 'master'

jobs:
  unit_tests:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Install packages
      run : |
        pip install numpy==1.22.2
        pip install torch==1.10.2+cpu torchvision==0.11.3+cpu torchaudio==0.10.2 -f https://download.pytorch.org/whl/torch_stable.html
        pip install -r requirements.txt
      shell: bash
    - name: Run python unit tests
      run: |
        invalid=0
        for file in unittest/*;
        do
          echo "Testing : $file"
          res=$(grep "GithubActionsIgnore" "$file" | wc -l || true)
          if [ "$res" = "0" ]
          then
            if PYTHONPATH=${GITHUB_WORKSPACE} python3 "$file"; then
              echo "::notice file=$file::Tests : ok"
            else
              echo "::error file=$file::Something wrong happened during execution"
              invalid=$((invalid+1))
            fi
          else
            echo "::warning file=$file::This file should be ignore on github actions"
          fi
        done
        if [ "$invalid" -eq 0 ]
        then
            echo "::notice title="All possible tests are valid"::Congratulation !"
            exit 0
        else
            echo "::error title="Final review"::Some tests return errors"
            exit 1
        fi
      shell: bash
  linter:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Black
        uses: psf/black@stable
        with:
          options: "--check -l 119"
      - name: Set up Python environment
        uses: actions/setup-python@v2
        with:
          python-version: "3.8"
      - name: flake8 Lint
        uses: py-actions/flake8@v2
        with:
          ignore: "E203,E722,I201,I100,BLK100,W503"
          max-line-length: "119"
