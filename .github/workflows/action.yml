name: Aloception unit tests
on:
  push:
    branches:
      - 'master'
  pull_request:
    branches:
      - 'master'

# permissions:
#   contents: read
#   checks: write

jobs:
  unit_tests:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Install packages
      run : |
        pip install numpy==1.22.2
        pip install torch==1.10.2+cpu torchvision==0.11.3+cpu torchaudio==0.10.2 -f https://download.pytorch.org/whl/torch_stable.html
        pip install -r requirements.txt
      shell: bash
    - name: Run python unit tests
      run: |
        invalid=0
        for file in unittest/*;
        do
          echo "Testing : $file"
          res=$(grep "GithubActionsIgnore" "$file" | wc -l || true)
          if [ "$res" = "0" ]
          then
            if PYTHONPATH=${GITHUB_WORKSPACE} python3 "$file"; then
              echo "::notice file=$file::Tests : ok"
            else
              echo "::error file=$file::Something wrong happened during execution"
              invalid=$((invalid+1))
            fi
          else
            echo "::warning file=$file::This file should be ignore on github actions"
          fi
        done
        if [ "$invalid" -eq 0 ]
        then
            echo "::notice title="All possible tests are valid"::Congratulation !"
            exit 0
        else
            echo "::error title="Final review"::Some tests return errors"
            exit 1
        fi
      shell: bash
  linter:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Black
        uses: psf/black@stable
        with:
          options: "--diff -l 119 -tpy38"
      - name: Setup Python
        uses: actions/setup-python@v2
        with:
          python-version: "3.8"
          architecture: x64
      - name: Checkout PyTorch
        uses: actions/checkout@master
      - name: Install flake8
        run: pip install flake8
      - name: Run flake8
        uses: suo/flake8-github-action@releases/v1
        with:
          checkName: 'linter'   # NOTE: this needs to be the same as the job name
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
